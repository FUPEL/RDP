<!doctype html>
<html lang="en" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
<!-- [Head] start -->
<head>
@@include('../layouts/head-page-meta.html', {'title': 'Input PO'})
@@include('../layouts/head-css.html')
<style>
  .autocomplete-suggestions {
    position: absolute;
    border: 1px solid #e2e8f0;
    background-color: #fff;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    width: 100%;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border-radius: 0.375rem;
    top: calc(100% + 0.25rem);
  }
  .autocomplete-suggestion-item {
    padding: 0.75rem;
    cursor: pointer;
    font-size: 0.875rem;
    color: #4a5568;
    border-bottom: 1px solid #f7fafc;
  }
  .autocomplete-suggestion-item:hover {
    background-color: #edf2f7;
  }
  .autocomplete-suggestion-item:last-child {
    border-bottom: none;
  }
  .validation-error-message {
    color: #ef4444;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    display: none;
  }
  .border-red-500 {
    border-color: #ef4444 !important;
  }
  .border-green-500 {
    border-color: #10b981 !important;
  }
  .customer-status {
    font-size: 0.75rem;
    margin-top: 0.25rem;
    font-weight: 500;
  }
  .customer-valid {
    color: #10b981;
  }
  .customer-invalid {
    color: #ef4444;
  }
</style>
</head>
<!-- [Head] end -->

<!-- [Body] Start -->
<body>
  @@include('../layouts/loader.html')
  @@include('../layouts/sidebar.html')
  @@include('../layouts/topbar.html')

<!-- [ Main Content ] start -->
<div class="pc-container">
  <div class="pc-content">
    @@include('../layouts/breadcrumb.html', {'breadcrumb-item': 'Marketing', 'breadcrumb-item-active': 'Input PO'})

    <div class="grid grid-cols-12 gap-x-6">
      <div class="col-span-12">
        <div class="card">
          <div class="card-header">
            <h5>Form Input Purchase Order</h5>
          </div>
          <div class="card-body">
            <form id="poForm">
              <div class="mb-4">
                <label for="noPo" class="block text-sm font-medium text-gray-700">NO PO <span class="text-red-500">*</span></label>
                <input type="text" id="noPo" name="noPo" class="form-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Masukkan nomor PO" required />
              </div>
              
              <div class="mb-4 relative">
                <label for="customerName" class="block text-sm font-medium text-gray-700">Nama Customer <span class="text-red-500">*</span></label>
                <input type="text" id="customerName" name="customerName" class="form-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Ketik nama customer..." autocomplete="off" required />
                <div id="customerSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                <div id="customerStatus" class="customer-status"></div>
              </div>
              
              <div class="mb-4 relative">
                <label for="salesName" class="block text-sm font-medium text-gray-700">Nama Sales <span class="text-red-500">*</span></label>
                <input type="text" id="salesName" name="salesName" class="form-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Ketik nama sales..." autocomplete="off" required />
                <div id="salesSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                <div id="salesStatus" class="customer-status"></div>
              </div>

              <div class="mb-4 relative">
                <label for="assyName" class="block text-sm font-medium text-gray-700">Nama ASSY <span class="text-red-500">*</span></label>
                <input type="text" id="assyName" name="assyName" class="form-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Ketik nama ASSY..." autocomplete="off" required />
                <div id="assySuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                <div id="assyStatus" class="customer-status"></div>
              </div>
              
              <div class="mb-4">
                <label for="qty" class="block text-sm font-medium text-gray-700">Qty <span class="text-red-500">*</span></label>
                <input type="number" id="qty" name="qty" min="1" class="form-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Masukkan jumlah" oninput="calculateTotal()" required />
              </div>
              
              <div class="mb-4">
                <label for="unitPrice" class="block text-sm font-medium text-gray-700">Harga Satuan <span class="text-red-500">*</span></label>
                <input type="number" id="unitPrice" name="unitPrice" min="0" step="0.01" class="form-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Masukkan harga satuan" oninput="calculateTotal()" required />
              </div>
              
              <div class="mb-4">
                <label for="ppn" class="block text-sm font-medium text-gray-700">PPN 11%</label>
                <input type="text" id="ppn" name="ppn" class="form-control mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm" readonly />
              </div>
              
              <div class="mb-6">
                <label for="totalPrice" class="block text-sm font-medium text-gray-700">Total Harga</label>
                <input type="text" id="totalPrice" name="totalPrice" class="form-control mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm" readonly />
              </div>
              
              <div id="formValidationMessage" class="validation-error-message"></div>
              
              <button type="submit" id="submitBtn" class="btn btn-primary disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="submitBtnText">Simpan PO</span>
                <span id="submitBtnLoader" class="hidden">
                  <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  Menyimpan...
                </span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@@include('../layouts/footer-block.html')
@@include('../layouts/footer-js.html')

<!-- Include Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../assets/js/supabase-config.js"></script>
<script src="../assets/js/role-based-menu.js"></script>

<script>
let customerValidationState = {
  isValid: false,
  customerData: null
};

let assyValidationState = {
  isValid: false,
  assyData: null
};

let salesValidationState = {
  isValid: false,
  salesData: null
};

// Global variable to store the current user's role
let currentUserRole = null;

function showNotification(message, isSuccess = true) {
  let notification = document.getElementById('customNotification');

  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'customNotification';
    notification.className = 'fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-xl z-50 hidden opacity-0 transition-opacity duration-500 flex items-center gap-3';
    document.body.appendChild(notification);

    const iconSpan = document.createElement('span');
    iconSpan.id = 'notificationIcon';
    iconSpan.className = 'text-2xl';
    notification.appendChild(iconSpan);

    const messageSpan = document.createElement('span');
    messageSpan.id = 'notificationMessage';
    messageSpan.className = 'font-semibold text-white';
    notification.appendChild(messageSpan);
  }

  const notificationIcon = notification.querySelector('#notificationIcon');
  const notificationMessage = notification.querySelector('#notificationMessage');

  notificationMessage.textContent = message;
  notificationIcon.textContent = isSuccess ? '✔' : '✖';

  notification.classList.remove('bg-green-600', 'bg-red-600', 'hidden', 'opacity-0');
  if (isSuccess) {
    notification.classList.add('bg-green-600');
  } else {
    notification.classList.add('bg-red-600');
  }
  notification.classList.add('text-white');

  notification.style.opacity = '1';
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => {
      notification.classList.add('hidden');
    }, 500);
  }, 3000);
}

function setSubmitButtonState(isLoading) {
  const submitBtn = document.getElementById('submitBtn');
  const submitBtnText = document.getElementById('submitBtnText');
  const submitBtnLoader = document.getElementById('submitBtnLoader');

  if (isLoading) {
    submitBtn.disabled = true;
    submitBtnText.classList.add('hidden');
    submitBtnLoader.classList.remove('hidden');
  } else {
    submitBtn.disabled = false;
    submitBtnText.classList.remove('hidden');
    submitBtnLoader.classList.add('hidden');
  }
}

function calculateTotal() {
  const qtyInput = document.getElementById('qty');
  const unitPriceInput = document.getElementById('unitPrice');
  const ppnInput = document.getElementById('ppn');
  const totalPriceInput = document.getElementById('totalPrice');

  const qty = parseFloat(qtyInput.value) || 0;
  const unitPrice = parseFloat(unitPriceInput.value) || 0;

  const subtotal = qty * unitPrice;
  const ppn = subtotal * 0.11;
  const total = subtotal + ppn;

  const formatter = new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });

  ppnInput.value = formatter.format(ppn);
  totalPriceInput.value = formatter.format(total);
}

async function validateCustomer(customerName) {
  const customerStatus = document.getElementById('customerStatus');
  const customerInput = document.getElementById('customerName');
  
  if (!customerName.trim()) {
    customerValidationState.isValid = false;
    customerValidationState.customerData = null;
    customerStatus.textContent = '';
    customerInput.classList.remove('border-green-500', 'border-red-500');
    return;
  }

  try {
    if (typeof window.DatabaseHelper === 'undefined') {
      throw new Error('Database connection not available');
    }

    const result = await window.DatabaseHelper.getCustomerByName(customerName);
    
    if (result.success && result.data) {
      customerValidationState.isValid = true;
      customerValidationState.customerData = result.data;
      customerStatus.textContent = '✓ Customer terdaftar';
      customerStatus.className = 'customer-status customer-valid';
      customerInput.classList.remove('border-red-500');
      customerInput.classList.add('border-green-500');
    } else {
      customerValidationState.isValid = false;
      customerValidationState.customerData = null;
      customerStatus.textContent = '✗ Customer belum terdaftar';
      customerStatus.className = 'customer-status customer-invalid';
      customerInput.classList.remove('border-green-500');
      customerInput.classList.add('border-red-500');
    }
  } catch (error) {
    console.error('Error validating customer:', error);
    customerValidationState.isValid = false;
    customerValidationState.customerData = null;
    customerStatus.textContent = '✗ Error validasi customer';
    customerStatus.className = 'customer-status customer-invalid';
    customerInput.classList.remove('border-green-500');
    customerInput.classList.add('border-red-500');
  }
}

async function validateAssy(assyName) {
  const assyStatus = document.getElementById('assyStatus');
  const assyInput = document.getElementById('assyName');

  if (!assyName.trim()) {
    assyValidationState.isValid = false;
    assyValidationState.assyData = null;
    assyStatus.textContent = '';
    assyInput.classList.remove('border-green-500', 'border-red-500');
    return;
  }

  try {
    if (typeof window.DatabaseHelper === 'undefined') {
      throw new Error('Database connection not available');
    }

    const result = await window.DatabaseHelper.getItemByName(assyName);
    
    if (result.success && result.data) {
      assyValidationState.isValid = true;
      assyValidationState.assyData = result.data;
      assyStatus.textContent = '✓ ASSY terdaftar';
      assyStatus.className = 'customer-status customer-valid';
      assyInput.classList.remove('border-red-500');
      assyInput.classList.add('border-green-500');
    } else {
      assyValidationState.isValid = false;
      assyValidationState.assyData = null;
      assyStatus.textContent = '✗ ASSY belum terdaftar';
      assyStatus.className = 'customer-status customer-invalid';
      assyInput.classList.remove('border-green-500');
      assyInput.classList.add('border-red-500');
    }
  } catch (error) {
    console.error('Error validating ASSY:', error);
    assyValidationState.isValid = false;
    assyValidationState.assyData = null;
    assyStatus.textContent = '✗ Error validasi ASSY';
    assyStatus.className = 'customer-status customer-invalid';
    assyInput.classList.remove('border-green-500');
    assyInput.classList.add('border-red-500');
  }
}

async function validateSales(salesName) {
  const salesStatus = document.getElementById('salesStatus');
  const salesInput = document.getElementById('salesName');

  if (!salesName.trim()) {
    salesValidationState.isValid = false;
    salesValidationState.salesData = null;
    salesStatus.textContent = '';
    salesInput.classList.remove('border-green-500', 'border-red-500');
    return;
  }

  // Check if the typed name exactly matches any cached sales display_name
  const foundSales = cachedSales.find(s => s.display_name && s.display_name.trim().toLowerCase() === salesName.trim().toLowerCase());

  if (foundSales) {
    salesValidationState.isValid = true;
    salesValidationState.salesData = foundSales;
    salesStatus.textContent = '✓ Sales terdaftar';
    salesStatus.className = 'customer-status customer-valid';
    salesInput.classList.remove('border-red-500');
    salesInput.classList.add('border-green-500');
  } else {
    salesValidationState.isValid = false;
    salesValidationState.salesData = null;
    salesStatus.textContent = '✗ Sales belum terdaftar';
    salesStatus.className = 'customer-status customer-invalid';
    salesInput.classList.remove('border-green-500');
    salesInput.classList.add('border-red-500');
  }
}

// Caching variables for autocomplete data
let cachedCustomers = [];
let cachedItems = [];
let cachedSales = [];

// Function to fetch and cache all customers
async function fetchAndCacheCustomers() {
  if (typeof window.DatabaseHelper === 'undefined') {
    console.warn('DatabaseHelper not available for fetching customers.');
    return;
  }
  if (cachedCustomers.length === 0) { // Only fetch if cache is empty
    const result = await window.DatabaseHelper.getCustomers();
    if (result.success) {
      cachedCustomers = result.data;
      console.log('Customers cached:', cachedCustomers.length);
    } else {
      console.error('Error fetching customers for cache:', result.error);
    }
  }
}

// Function to fetch and cache all items (ASSY)
async function fetchAndCacheItems() {
  if (typeof window.DatabaseHelper === 'undefined') {
    console.warn('DatabaseHelper not available for fetching items.');
    return;
  }
  if (cachedItems.length === 0) { // Only fetch if cache is empty
    const result = await window.DatabaseHelper.getItems();
    if (result.success) {
      cachedItems = result.data;
      console.log('Items cached:', cachedItems.length);
    } else {
      console.error('Error fetching items for cache:', result.error);
    }
  }
}

// Function to fetch and cache sales based on user role
async function fetchAndCacheSales() {
  if (typeof window.DatabaseHelper === 'undefined') {
    console.warn('DatabaseHelper not available for fetching sales.');
    return;
  }

  const client = window.DatabaseHelper._getSupabaseClient();
  if (!client) {
    console.error("Supabase client is not initialized for fetching sales.");
    return;
  }

  if (currentUserRole === 'Sales') {
    // If current user is Sales, only fetch their own profile
    const currentUser = await window.DatabaseHelper.getCurrentUser();
    if (currentUser) {
      // Fetch the current user's profile to get their display_name and confirm role
      const { data: profileData, error: profileError } = await client
        .from("profiles")
        .select("id, display_name")
        .eq("id", currentUser.id)
        .eq("role", "Sales") // Ensure they are indeed a 'Sales' role
        .single();
      
      if (profileError) {
        console.error('Error fetching current sales user profile:', profileError);
        cachedSales = [];
      } else if (profileData) {
        cachedSales = [profileData]; // Store only their own profile
        console.log('Sales (current user only) cached:', cachedSales);
      } else {
        cachedSales = [];
        console.log('Current user is Sales but no matching profile found or not a Sales role.');
      }
    } else {
      cachedSales = [];
      console.log('No current user found to fetch sales profile.');
    }
  } else {
    // For Marketing or higher roles, fetch all sales profiles
    const { data, error } = await client
      .from("profiles")
      .select("id, display_name")
      .eq("role", "Sales")
      .order("display_name", { ascending: true });
    
    if (error) {
      console.error('Error fetching all sales for cache:', error);
      cachedSales = [];
    } else {
      cachedSales = data || [];
      console.log('All Sales profiles cached:', cachedSales.length);
    }
  }
}

async function setupCustomerAutocomplete() {
  const input = document.getElementById('customerName');
  const suggestionsContainer = document.getElementById('customerSuggestions');
  let debounceTimer;

  // Pre-fetch customers when the autocomplete is set up
  await fetchAndCacheCustomers();

  input.addEventListener('input', function() {
    const searchTerm = this.value.trim();
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      await showCustomerSuggestions(searchTerm);
      await validateCustomer(searchTerm);
    }, 300);
  });

  input.addEventListener('focus', async function() {
    // Show all suggestions when focused, or filter if something is already typed
    await showCustomerSuggestions(this.value.trim());
  });

  async function showCustomerSuggestions(searchTerm) {
    suggestionsContainer.innerHTML = '';
    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    const filteredSuggestions = cachedCustomers
      .filter(customer => 
        (customer.customer_name && customer.customer_name.toLowerCase().includes(lowerCaseSearchTerm)) || 
        (customer.initial_customer && customer.initial_customer.toLowerCase().includes(lowerCaseSearchTerm))
      )
      .slice(0, 5); // Limit to 5 suggestions

    if (filteredSuggestions.length > 0) {
      filteredSuggestions.forEach(customer => {
        const suggestionItem = document.createElement('div');
        suggestionItem.classList.add('autocomplete-suggestion-item');
        suggestionItem.innerHTML = `
          <div class="font-medium">${customer.customer_name} <span class="text-gray-500 text-sm">(${customer.initial_customer || 'N/A'})</span></div>
          <div class="text-xs text-gray-500">${customer.pic_name || 'N/A'} - ${customer.phone_number || 'N/A'}</div>
        `;
        
        suggestionItem.addEventListener('mousedown', (e) => {
          e.preventDefault(); // Prevent input blur when clicking suggestion
        });
        
        suggestionItem.addEventListener('click', function() {
          input.value = customer.customer_name.trim(); // Trim value on selection
          suggestionsContainer.innerHTML = '';
          suggestionsContainer.style.display = 'none';
          validateCustomer(customer.customer_name.trim());
        });
        
        suggestionsContainer.appendChild(suggestionItem);
      });
      suggestionsContainer.style.display = 'block';
    } else {
      suggestionsContainer.style.display = 'none';
    }
  }

  input.addEventListener('blur', function() {
    // Delay hiding to allow click on suggestion items
    setTimeout(() => {
      suggestionsContainer.style.display = 'none';
    }, 150);
  });
}

async function setupAssyAutocomplete() {
  const input = document.getElementById('assyName');
  const suggestionsContainer = document.getElementById('assySuggestions');
  let debounceTimer;

  // Pre-fetch items when the autocomplete is set up
  await fetchAndCacheItems();

  input.addEventListener('input', function() {
    const searchTerm = this.value.trim();
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      await showAssySuggestions(searchTerm);
      await validateAssy(searchTerm);
    }, 300);
  });

  input.addEventListener('focus', async function() {
    // Show all suggestions when focused, or filter if something is already typed
    await showAssySuggestions(this.value.trim());
  });

  async function showAssySuggestions(searchTerm) {
    suggestionsContainer.innerHTML = '';
    const filteredSuggestions = cachedItems
      .filter(item => item.part_assy_name && item.part_assy_name.toLowerCase().includes(searchTerm.toLowerCase()))
      .slice(0, 5); // Limit to 5 suggestions

    if (filteredSuggestions.length > 0) {
      filteredSuggestions.forEach(item => {
        const suggestionItem = document.createElement('div');
        suggestionItem.classList.add('autocomplete-suggestion-item');
        suggestionItem.innerHTML = `
          <div class="font-medium">${item.part_assy_name}</div>
          <div class="text-xs text-gray-500">Part Details: ${item.part_details?.length || 0} items</div>
        `;
        
        suggestionItem.addEventListener('mousedown', (e) => {
          e.preventDefault(); // Prevent input blur when clicking suggestion
        });
        
        suggestionItem.addEventListener('click', function() {
          input.value = item.part_assy_name.trim(); // Trim value on selection
          suggestionsContainer.innerHTML = '';
          suggestionsContainer.style.display = 'none';
          validateAssy(item.part_assy_name.trim());
        });
        
        suggestionsContainer.appendChild(suggestionItem);
      });
      suggestionsContainer.style.display = 'block';
    } else {
      suggestionsContainer.style.display = 'none';
    }
  }

  input.addEventListener('blur', function() {
    // Delay hiding to allow click on suggestion items
    setTimeout(() => {
      suggestionsContainer.style.display = 'none';
    }, 150);
  });
}

async function setupSalesAutocomplete() {
  const input = document.getElementById('salesName');
  const suggestionsContainer = document.getElementById('salesSuggestions');
  let debounceTimer;

  // Pre-fetch sales based on the determined currentUserRole
  await fetchAndCacheSales();

  // If the user is 'Sales', and their own name is the only one, pre-fill and disable the input
  if (currentUserRole === 'Sales' && cachedSales.length === 1) {
    input.value = cachedSales[0].display_name.trim(); // Trim value on pre-fill
    input.readOnly = true; // Make it read-only
    input.classList.add('bg-gray-100'); // Add a class for visual indication
    validateSales(input.value); // Validate immediately
    // No need for event listeners if it's read-only, so return early
    return;
  }

  // Only add event listeners if the input is not read-only (i.e., for Marketing/Direktur roles)
  input.addEventListener('input', function() {
    const searchTerm = this.value.trim();
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      await showSalesSuggestions(searchTerm);
      await validateSales(searchTerm);
    }, 300);
  });

  input.addEventListener('focus', async function() {
    await showSalesSuggestions(this.value.trim()); // Show all/filtered suggestions when focused
  });

  async function showSalesSuggestions(searchTerm) {
    suggestionsContainer.innerHTML = '';
    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    // Filter by display_name
    const filteredSuggestions = cachedSales
      .filter(sales => sales.display_name && sales.display_name.trim().toLowerCase().includes(lowerCaseSearchTerm))
      .slice(0, 5); // Limit to 5 suggestions

    if (filteredSuggestions.length > 0) {
      filteredSuggestions.forEach(sales => {
        const suggestionItem = document.createElement('div');
        suggestionItem.classList.add('autocomplete-suggestion-item');
        // Display display_name
        suggestionItem.innerHTML = `
          <div class="font-medium">${sales.display_name}</div>
        `;
        
        suggestionItem.addEventListener('mousedown', (e) => {
          e.preventDefault(); // Prevent input blur when clicking suggestion
        });
        
        suggestionItem.addEventListener('click', function() {
          input.value = sales.display_name.trim(); // Set input value to display_name and trim
          suggestionsContainer.innerHTML = '';
          suggestionsContainer.style.display = 'none';
          validateSales(sales.display_name.trim()); // Validate after selection and trim
        });
        
        suggestionsContainer.appendChild(suggestionItem);
      });
      suggestionsContainer.style.display = 'block';
    } else {
      suggestionsContainer.style.display = 'none';
    }
  }

  input.addEventListener('blur', function() {
    // Delay hiding to allow click on suggestion items
    setTimeout(() => {
      suggestionsContainer.style.display = 'none';
      validateSales(input.value.trim()); // Validate on blur to catch manual entries and trim
    }, 150);
  });
}


document.addEventListener('DOMContentLoaded', async function() {
  calculateTotal();

  // First, get the current user's role
  if (typeof window.DatabaseHelper !== 'undefined') {
    const currentUser = await window.DatabaseHelper.getCurrentUser();
    if (currentUser) {
      const profile = await window.DatabaseHelper.getUserProfile(currentUser.id);
      if (profile && profile.role) {
        currentUserRole = profile.role;
        console.log('Current user role:', currentUserRole);
      } else {
        console.warn('Could not retrieve user profile or role.');
      }
    } else {
      console.warn('No current user session found.');
    }
  } else {
    console.error('DatabaseHelper not available on DOMContentLoaded.');
  }
 
  // Then, setup autocompletes, which will now use the determined currentUserRole
  await setupCustomerAutocomplete();
  await setupAssyAutocomplete();
  await setupSalesAutocomplete();

  const poForm = document.getElementById('poForm');
  const formValidationMessage = document.getElementById('formValidationMessage');

  poForm.addEventListener('submit', async function(event) {
    event.preventDefault();

    poForm.querySelectorAll('input').forEach(input => {
      if (input.id !== 'customerName' && input.id !== 'assyName' && input.id !== 'salesName') {
        input.classList.remove('border-red-500');
      }
    });
    formValidationMessage.textContent = '';
    formValidationMessage.style.display = 'none';

    let isValid = true;
    let errorMessages = [];

    const requiredInputs = poForm.querySelectorAll('[required]');
    requiredInputs.forEach(input => {
      if (!input.value.trim() || (input.type === 'number' && parseFloat(input.value) <= 0)) {
        if (input.id !== 'customerName' && input.id !== 'assyName' && input.id !== 'salesName') {
          input.classList.add('border-red-500');
        }
        isValid = false;
      }
    });

    if (!isValid) {
      errorMessages.push("❌ Harap isi semua kolom yang wajib diisi dengan benar!");
    }

    if (!customerValidationState.isValid) {
      errorMessages.push("❌ Customer belum terdaftar. Silakan daftarkan customer terlebih dahulu.");
      isValid = false;
    }

    if (!assyValidationState.isValid) {
      errorMessages.push("❌ ASSY belum terdaftar. Silakan daftarkan ASSY terlebih dahulu.");
      isValid = false;
    }

    if (!salesValidationState.isValid) { // Add this validation
      errorMessages.push("❌ Nama Sales belum terdaftar. Silakan pilih sales dari daftar.");
      isValid = false;
    }

    if (!isValid) {
      formValidationMessage.innerHTML = errorMessages.join('<br>');
      formValidationMessage.style.display = 'block';
      showNotification("❌ Form tidak dapat disubmit. Harap perbaiki kesalahan.", false);
      return;
    }

    setSubmitButtonState(true);

    try {
      if (typeof window.DatabaseHelper === 'undefined') {
        throw new Error('Database connection not available. Please refresh the page.');
      }

      const currentDate = new Date();
      const poDate = currentDate.toISOString().split('T')[0];

      const poData = {
        no_po: document.getElementById('noPo').value.trim(),
        customer_name: customerValidationState.customerData.customer_name,
        sales_name: salesValidationState.salesData.display_name, // Menggunakan display_name dari salesData
        assy_name: assyValidationState.assyData.part_assy_name,
        qty: parseInt(document.getElementById('qty').value),
        unit_price: parseFloat(document.getElementById('unitPrice').value),
        ppn: parseFloat(document.getElementById('ppn').value.replace(/[^\d.-]/g, '')),
        total_price: parseFloat(document.getElementById('totalPrice').value.replace(/[^\d.-]/g, '')),
        po_date: poDate,
        created_at: new Date().toISOString()
      };

      console.log('Saving PO data:', poData);

      const result = await window.DatabaseHelper.savePO(poData);
      
      if (result.success) {
        showNotification("✅ PO berhasil disimpan ke database!", true);
        poForm.reset();
        calculateTotal();
        formValidationMessage.style.display = 'none';
        
        customerValidationState.isValid = false;
        customerValidationState.customerData = null;
        document.getElementById('customerStatus').textContent = '';
        document.getElementById('customerName').classList.remove('border-green-500', 'border-red-500');

        assyValidationState.isValid = false;
        assyValidationState.assyData = null;
        document.getElementById('assyStatus').textContent = '';
        document.getElementById('assyName').classList.remove('border-green-500', 'border-red-500');

        salesValidationState.isValid = false; // Reset sales validation state
        salesValidationState.salesData = null;
        document.getElementById('salesStatus').textContent = '';
        document.getElementById('salesName').classList.remove('border-green-500', 'border-red-500');

        // Re-setup sales autocomplete to reflect role-based behavior after reset
        // This is important if the user's role somehow changes or if the form is reset
        // and we want the sales field to re-initialize based on the current role.
        // However, for a single-page app, the role won't change without a full reload.
        // So, this might be redundant but harmless.
        // If the input was readOnly, resetting the form will clear it, so we need to re-apply the readOnly state.
        const salesInput = document.getElementById('salesName');
        if (currentUserRole === 'Sales' && cachedSales.length === 1) {
            salesInput.value = cachedSales[0].display_name.trim(); // Trim value on pre-fill
            salesInput.readOnly = true;
            salesInput.classList.add('bg-gray-100');
            validateSales(salesInput.value);
        } else {
            salesInput.readOnly = false;
            salesInput.classList.remove('bg-gray-100');
        }

      } else {
        showNotification(`❌ Gagal menyimpan PO: ${result.error}`, false);
      }
    } catch (error) {
      console.error('Error in PO submission:', error);
      showNotification(`❌ Terjadi kesalahan: ${error.message}`, false);
    } finally {
      setSubmitButtonState(false);
    }
  });
});
</script>

</body>
<!-- [Body] end -->
</html>
