<!doctype html>
<html lang="en" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
<head>
@@include('../layouts/head-page-meta.html', {'title': 'Input Mesin'})
@@include('../layouts/head-css.html')
</head>
<body>
@@include('../layouts/loader.html')
@@include('../layouts/sidebar.html')
@@include('../layouts/topbar.html')

<div class="pc-container" data-page-role="Direktur,Produksi">
  <div class="pc-content">
    @@include('../layouts/breadcrumb.html', {'breadcrumb-item': 'Data Master', 'breadcrumb-item-active': 'Input Mesin', 'breadcrumb-item-href': '#'})
    <div class="grid grid-cols-12 gap-x-6">
      <div class="col-span-12">
        <div class="card">
          <div class="card-header">
            <h5>Input Nama Mesin</h5>
          </div>
          <div class="card-body">
            <form id="machineForm" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="space-y-2">
                  <label for="machineName" class="block text-sm font-medium text-gray-700">Nama Mesin</label>
                  <input type="text" id="machineName" name="machineName" placeholder="Masukkan nama mesin" class="form-input block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" required autocomplete="off" />
                </div>
              </div>

              <div class="flex flex-col items-start gap-2">
                <button type="submit" class="bg-primary-500 hover:bg-primary-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out w-full md:w-auto" id="submitBtn">
                  <span id="submitText">Submit Data</span>
                  <span id="submitLoader" class="hidden">
                    <i class="fas fa-spinner fa-spin me-2"></i>Menyimpan...
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="globalErrorDisplay" class="fixed top-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-lg shadow-xl z-[9999] hidden opacity-0 transition-opacity duration-500">
  Terjadi kesalahan fatal. Mohon coba lagi atau hubungi administrator.
</div>

@@include('../layouts/footer-block.html')
@@include('../layouts/footer-js.html')

<script>
layout_change('false');
</script>
 
<script>
layout_theme_sidebar_change('dark');
</script>

<script>
change_box_container('false');
</script>
 
<script>
layout_caption_change('true');
</script>
 
<script>
layout_rtl_change('false');
</script>
 
<script>
preset_change('preset-1');
</script>
 
<script>
main_layout_change('vertical');
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../assets/js/supabase-config.js"></script>
<script src="../assets/js/role-based-menu.js"></script>

<script>
console.log('input-mesin.html: Inline script started.');

// Function to show a temporary notification
function showNotification(message, isSuccess = true) {
  let notification = document.getElementById('customNotification');
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'customNotification';
    // Changed z-index from z-50 to z-[9999]
    notification.className = 'fixed top-4 right-4 px-6 py-4 rounded-lg shadow-xl z-[9999] hidden opacity-0 transition-opacity duration-500 flex items-center gap-3';
    document.body.appendChild(notification); // Append to body for fixed positioning

    const iconSpan = document.createElement('span');
    iconSpan.id = 'notificationIcon';
    iconSpan.className = 'text-2xl';
    notification.appendChild(iconSpan);

    const messageSpan = document.createElement('span');
    messageSpan.id = 'notificationMessage';
    messageSpan.className = 'font-semibold';
    notification.appendChild(messageSpan);
  }

  const notificationIcon = document.getElementById('notificationIcon');
  const notificationMessage = document.getElementById('notificationMessage');

  if (!notification || !notificationIcon || !notificationMessage) {
    console.error('Notification elements not found. Please ensure #customNotification, #notificationIcon, and #notificationMessage exist in the HTML or are correctly created by JS.');
    return;
  }

  notificationMessage.textContent = message;
  notificationIcon.textContent = isSuccess ? '✅' : '❌';

  // Remove previous state classes
  notification.classList.remove('bg-green-600', 'bg-red-600', 'hidden', 'opacity-0');

  // Add new state classes
  if (isSuccess) {
    notification.classList.add('bg-green-600', 'text-white');
  } else {
    notification.classList.add('bg-red-600', 'text-white');
  }

  // Make visible and fade in
  notification.classList.remove('hidden');
  setTimeout(() => {
    notification.style.opacity = '1';
  }, 10);

  // Hide after 3 seconds
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => {
      notification.classList.add('hidden');
    }, 500);
  }, 3000);
}

// Function to show a persistent global error message
function showGlobalError() {
  const errorDisplay = document.getElementById('globalErrorDisplay');
  if (errorDisplay) {
    errorDisplay.classList.remove('hidden', 'opacity-0');
    errorDisplay.style.opacity = '1';
    console.error('Global error display shown.');
  }
}

// Function to set the state of the submit button (loading/normal)
function setSubmitButtonState(isLoading) {
  const submitBtn = document.getElementById('submitBtn');
  const submitText = document.getElementById('submitText');
  const submitLoader = document.getElementById('submitLoader');

  if (submitBtn && submitText && submitLoader) {
    if (isLoading) {
      submitBtn.disabled = true;
      submitText.classList.add('hidden');
      submitLoader.classList.remove('hidden');
      console.log('Submit button state: Loading');
    } else {
      submitBtn.disabled = false;
      submitText.classList.remove('hidden');
      submitLoader.classList.add('hidden');
      console.log('Submit button state: Normal');
    }
  }
}

document.addEventListener('DOMContentLoaded', async function() {
  console.log('input-mesin.html: DOMContentLoaded fired.');

  const loader = document.querySelector(".loader-bg");
  if (loader) {
    loader.style.display = 'none';
    loader.style.opacity = '0';
    loader.remove();
    console.log('input-mesin.html: Loader hidden immediately on DOMContentLoaded.');
  }

  const form = document.getElementById('machineForm');
  if (form) {
    console.log("input-mesin.html: Attaching form submit listener.");
    form.addEventListener('submit', async function(event) {
      event.preventDefault();
      console.log('Form submission prevented default.');

      this.querySelectorAll('.validation-message').forEach(msg => msg.remove());
      this.querySelectorAll('input').forEach(el => el.style.borderColor = '');

      let allFieldsFilled = true;
      const machineNameInput = document.getElementById('machineName');
      const machineName = machineNameInput.value.trim();

      if (!machineName) {
        machineNameInput.style.borderColor = 'red';
        allFieldsFilled = false;
        const errorMessage = document.createElement('div');
        errorMessage.className = 'text-red-500 text-xs mt-1 validation-message';
        errorMessage.textContent = 'Nama Mesin harus diisi.';
        machineNameInput.parentNode.insertBefore(errorMessage, machineNameInput.nextSibling);
      }

      if (!allFieldsFilled) {
        showNotification("❌ Harap isi semua kolom yang wajib diisi!", false);
        return;
      }

      setSubmitButtonState(true);

      try {
        const dataToSave = {
          machine_name: machineName
        };

        console.log('Saving machine data:', dataToSave);
        // Assuming DatabaseHelper.saveData is available and handles insertion
        const result = await window.DatabaseHelper.saveData('machines', dataToSave);

        if (result.success) {
          showNotification('Nama mesin berhasil disimpan!', true);
          form.reset();
          console.log('Machine data saved successfully and form reset.');
        } else {
          console.error('Error saat menyimpan:', result.error);
          showNotification(`Gagal menyimpan data: ${result.error}`, false);
          showGlobalError();
        }
      } catch (error) {
        console.error('Pengecualian saat menyimpan:', error);
        showNotification(`Terjadi kesalahan: ${error.message}`, false);
        showGlobalError();
      } finally {
        setSubmitButtonState(false);
        console.log('Proses pengiriman formulir selesai.');
      }
    });
  } else {
    console.error("Formulir dengan ID 'machineForm' tidak ditemukan.");
    showGlobalError();
  }
});
</script>
</body>
</html>
